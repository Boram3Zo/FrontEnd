# 🔄 산책-경로-저장-API-연동

> **작업 유형**: 기능 변경/수정  
> **작업 날짜**: 2025-09-14  
> **담당자**: GitHub Copilot

## 📋 작업 개요

### 문제 상황

- `WalkSummary` 컴포넌트의 "저장하기" 버튼이 콘솔 로그만 출력하는 임시 상태였음
- 사용자가 완료한 산책 경로를 실제 서버에 저장할 수 있는 기능이 필요했음

### 요구사항

- 산책 완료 후 "저장하기" 버튼 클릭 시 `POST /post/save-route` API를 호출
- 세션 데이터(경로, 시간, 거리 등)를 API 스펙에 맞게 변환하여 전송
- 저장 중 상태 표시 및 성공/실패 피드백 제공
- 세션 기반 인증을 통한 사용자 식별

## 🔧 변경 사항

### 새로 생성된 파일

- `app/_libs/routeService.ts` - 경로 저장 API 서비스

### 수정된 파일

- `app/_components/walk/WalkSummary.tsx` - 저장 버튼 로직 구현

### 주요 변경 내용

1. **routeService.saveRoute()**: 세션 데이터를 API 스펙에 맞는 페이로드로 변환 후 서버 전송
2. **WalkSummary.handleSaveRoute()**: 저장 버튼 클릭 시 실행되는 비동기 핸들러 구현
3. **저장 상태 관리**: `isSaving` state를 통한 중복 클릭 방지 및 UI 피드백

### 코드 변경 예시

#### routeService.ts (신규 생성)

```typescript
export async function saveRoute(
	session: WalkingSession,
	pins: WalkingPin[],
	memberId: number,
	title?: string,
	content?: string,
	theme?: string,
	hashtags?: string[]
): Promise<SaveRouteResponse> {
	// 시작/종료 지점 추출 및 페이로드 구성
	const payload: SaveRouteRequest = {
		memberId,
		title: title || `산책 경로 - ${new Date().toLocaleDateString()}`,
		region: startPin?.addressDetailed?.gu || startPin?.address || "미지정",
		duration: formatDuration(session.durationSec),
		distance: session.distanceKm,
		// ... 기타 필드들
		map: {
			startLatitude: startPin?.lat.toString() || "0",
			startLongitude: startPin?.lng.toString() || "0",
			// ...
			spots: JSON.stringify(session.route || []),
		},
	};

	return await ApiClient.post<SaveRouteResponse>("/post/save-route", payload);
}
```

#### WalkSummary.tsx 저장 버튼 변경

```typescript
// Before (기존 코드)
<Button onClick={() => {
    console.log("[save] walking record saved");
}}>
    저장하기
</Button>

// After (수정된 코드)
<Button
    onClick={handleSaveRoute}
    disabled={isSaving}
>
    {isSaving ? "저장 중..." : "저장하기"}
</Button>
```

## ✅ 개선 효과

### 사용자 경험 개선

- **실제 저장 기능**: 산책 완료 후 경로를 실제로 서버에 저장 가능
- **즉시 피드백**: 저장 중/완료/실패 상태를 사용자에게 명확히 표시
- **중복 방지**: 저장 중 버튼 비활성화로 중복 요청 방지
- **성공 확인**: 저장 완료 시 생성된 경로 ID와 함께 성공 메시지 표시

### 기술적 개선

- **API 연동**: 백엔드 API 스펙에 맞는 완전한 연동 구현
- **타입 안전성**: TypeScript 타입 정의로 API 요청/응답 구조 보장
- **세션 기반 인증**: `credentials: 'include'`를 통한 자동 인증 처리
- **확장 가능한 구조**: 추후 사진 업로드, 해시태그 등 기능 확장 용이

## 🧪 테스트

### 테스트 시나리오

1. **정상 저장 테스트**: 산책 완료 → WalkSummary → "저장하기" 클릭 → 성공 메시지 확인
2. **저장 중 상태 테스트**: 저장 버튼 클릭 → "저장 중..." 텍스트 및 버튼 비활성화 확인
3. **네트워크 에러 테스트**: 서버 연결 실패 시 에러 메시지 표시 확인
4. **세션 데이터 변환 테스트**: 다양한 경로 데이터로 API 페이로드 올바른 생성 확인

### 확인 사항

- [x] 저장 버튼 클릭 시 `POST /post/save-route` API 호출 확인
- [x] 세션 데이터가 API 스펙에 맞게 변환되는가?
- [x] 저장 중/완료/실패 상태가 적절히 표시되는가?
- [x] 중복 클릭 시 중복 요청이 방지되는가?
- [x] 기존 WalkSummary 표시 기능에 영향이 없는가?

### API 테스트 확인

```bash
# 네트워크 탭에서 확인할 요청
POST /post/save-route
Content-Type: application/json
Cookie: JSESSIONID=...

# 예상 응답
{
  "success": true,
  "data": 456,
  "message": null
}
```

## 📖 사용법

### 사용자 워크플로우

1. **산책 시작**: 산책 트래킹 시작
2. **산책 완료**: 종료 버튼 클릭 → WalkSummary 화면 이동
3. **경로 저장**: "저장하기" 버튼 클릭
4. **확인**: "저장 중..." → "경로가 성공적으로 저장되었습니다! (ID: 456)" 메시지 확인

### 개발자 사용법

#### 경로 저장 서비스 직접 호출

```typescript
import { saveRoute } from "@/app/_libs/routeService";

// 세션과 핀 데이터로 경로 저장
const result = await saveRoute(walkingSession, pins, memberId, "내 산책 경로", "오늘 날씨가 좋아서 걸었어요", "휴식", [
	"산책",
	"운동",
	"건강",
]);

console.log("저장된 경로 ID:", result.data);
```

#### 다른 컴포넌트에서 활용

```typescript
// 다른 컴포넌트에서도 동일한 방식으로 사용 가능
import { saveRoute } from "@/app/_libs/routeService";

const MyComponent = () => {
	const handleSave = async () => {
		try {
			const result = await saveRoute(session, pins, userId);
			// 성공 처리
		} catch (error) {
			// 에러 처리
		}
	};
};
```

## 🔗 관련 링크

- API 문서: `POST /post/save-route` 스펙
- 관련 컴포넌트: `WalkSummary.tsx`, `useWalkTracker.ts`
- 이전 작업: 사진 업로드 API 연동 (`POST /post/upload-photo`)

## 📝 비고

### 현재 제한사항

- `memberId`는 임시값(1) 사용 중 → 실제 인증된 사용자 ID로 변경 필요
- `photoList`는 기본 구조만 구현 → 실제 사진 업로드 API와 연동 필요
- 해시태그, 테마 선택은 기본값 사용 → 사용자 입력 UI 추가 가능

### 향후 개선 방향

1. **인증 연동**: `useAuth` 훅에서 실제 사용자 ID 추출
2. **사진 통합**: 사진 업로드 후 해당 메타데이터를 `photoList`에 포함
3. **UI 개선**: 저장 성공 후 상세 페이지로 이동 또는 공유 옵션 제공
4. **오프라인 지원**: 네트워크 연결 실패 시 로컬 저장 후 나중에 동기화
5. **테스트 추가**: `routeService.test.ts` 단위 테스트 파일 생성

### API 응답 처리 참고

```typescript
// 성공 응답 예시
{
  "success": true,
  "data": 456,
  "message": null
}

// 실패 응답 예시
{
  "success": false,
  "data": null,
  "message": "세션이 만료되었습니다"
}
```
