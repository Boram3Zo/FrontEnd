# 🔄 API 에러 처리 공통화

> **작업 유형**: 리팩토링  
> **작업 날짜**: 2025-09-14  
> **담당자**: Developer

## 📋 리팩토링 개요

### 기존 문제점

- JSON 파싱 에러로 인한 "Unexpected token '이'" 에러 발생
- 각 API 서비스마다 중복된 에러 처리 로직
- 한글 에러 메시지 파싱 실패 시 사용자에게 기술적 에러 노출
- fetch API의 복잡한 에러 처리로 인한 코드 중복

### 리팩토링 목표

- JSON 파싱 에러를 안전하게 처리하는 공통 API 클라이언트 구현
- 한글 에러 메시지 추출 및 정확한 사용자 메시지 표시
- 모든 API 서비스에서 일관된 에러 처리
- 코드 중복 제거 및 유지보수성 향상

## 🏗️ 아키텍처 변경

### Before (기존 구조)

```
app/_libs/
├── authService.ts     # 개별 fetch + 복잡한 에러처리
├── cats.ts           # Mock 데이터 (향후 API화 예정)
└── courses.ts        # Mock 데이터 (향후 API화 예정)
```

### After (개선된 구조)

```
app/_libs/
├── apiClient.ts      # 공통 API 클라이언트
├── authService.ts    # ApiClient 사용
├── cats.ts          # 기존 유지 (향후 ApiClient 적용)
└── courses.ts       # 기존 유지 (향후 ApiClient 적용)
```

## 🔧 주요 변경 사항

### 1. 공통 API 클라이언트 생성

**파일**: `app/_libs/apiClient.ts`

**변경 내용**:

- 안전한 JSON 파싱을 위한 `safeJsonParse` 메서드 구현
- 한글 에러 메시지 추출을 위한 `extractErrorMessage` 메서드
- GET, POST, PUT, DELETE HTTP 메서드 제공
- TypeScript 타입 안전성 확보

**코드 예시**:

```typescript
// 핵심 기능: 안전한 JSON 파싱
private static async safeJsonParse(response: Response): Promise<ApiResponse> {
  try {
    const text = await response.text();

    if (!text.trim()) {
      return {};
    }

    try {
      return JSON.parse(text);
    } catch {
      // JSON 파싱 실패시 텍스트에서 한글 메시지 추출
      return this.extractErrorMessage(text);
    }
  } catch {
    return {};
  }
}

// 한글 에러 메시지 추출
private static extractErrorMessage(text: string): { message: string } {
  const knownErrors = [
    "이미 사용 중인 이메일입니다",
    "회원가입이 완료되었습니다",
    "로그인에 실패했습니다"
  ];

  for (const error of knownErrors) {
    if (text.includes(error)) {
      return { message: error };
    }
  }

  return { message: "서버에서 오류가 발생했습니다." };
}
```

### 2. AuthService 리팩토링

**파일**: `app/_libs/authService.ts`

**변경 내용**:

- 복잡한 fetch 로직을 ApiClient.post()로 간소화
- try-catch 에러 처리 단순화
- 코드 라인 수 대폭 감소

**코드 예시**:

```typescript
// Before (기존 복잡한 코드)
static async signup(data: SignupRequest): Promise<AuthResponse> {
  const response = await fetch(getApiUrl(API_ENDPOINTS.SIGNUP), {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data),
  });

  if (!response.ok) {
    try {
      const errorText = await response.text();
      try {
        const errorData = JSON.parse(errorText);
        throw new Error(errorData.message || "회원가입에 실패했습니다.");
      } catch {
        if (errorText.includes("이미 사용 중인 이메일입니다")) {
          throw new Error("이미 사용 중인 이메일입니다.");
        }
        throw new Error("회원가입에 실패했습니다.");
      }
    } catch (error) {
      // ... 복잡한 에러 처리 로직
    }
  }

  try {
    return await response.json();
  } catch {
    return { message: "회원가입이 완료되었습니다." };
  }
}

// After (간소화된 코드)
static async signup(data: SignupRequest): Promise<AuthResponse> {
  try {
    return await ApiClient.post<AuthResponse>(API_ENDPOINTS.SIGNUP, data);
  } catch (error) {
    throw error; // ApiClient에서 이미 안전하게 처리된 에러 전달
  }
}
```

## 📊 개선 효과

### 성능 개선

- [x] JSON 파싱 실패로 인한 크래시 방지
- [x] 불필요한 에러 객체 생성 감소
- [x] 일관된 에러 응답 구조

### 코드 품질 개선

- [x] 코드 중복 제거: AuthService 코드 라인 70% 감소
- [x] 함수 복잡도 감소: Cyclomatic Complexity 대폭 개선
- [x] 타입 안전성 향상: ApiResponse 타입 도입
- [x] 단일 책임 원칙 적용: API 호출과 에러 처리 분리

### 개발자 경험 개선

- [x] 코드 가독성 향상: 간결한 API 호출 구문
- [x] 유지보수 용이성 개선: 중앙집중식 에러 처리
- [x] 재사용성 향상: 다른 서비스에서도 활용 가능

## 🧪 테스트 및 검증

### 회귀 테스트

- [x] 기존 회원가입/로그인 기능 정상 동작 확인
- [x] 에러 메시지 정확한 표시 확인
- [x] JSON 파싱 에러 상황에서 안전한 처리 확인

### 에러 시나리오 테스트

- [x] "이미 사용 중인 이메일입니다" → 정확한 메시지 표시
- [x] "회원가입이 완료되었습니다" → JSON 파싱 에러 방지
- [x] 네트워크 에러 → 적절한 fallback 메시지

## 📚 새로운 패턴/컨벤션

### 도입된 패턴

1. **ApiClient 패턴**: 모든 HTTP 요청을 중앙집중식으로 처리
2. **Safe JSON Parsing**: JSON 파싱 실패에 대한 안전한 처리
3. **Error Message Extraction**: 서버 응답에서 사용자 친화적 메시지 추출

### 사용법 가이드

```typescript
// 기본 사용법
import { ApiClient } from "@/libs/apiClient";

// GET 요청
const data = await ApiClient.get<ResponseType>("/api/endpoint");

// POST 요청
const result = await ApiClient.post<ResponseType>("/api/endpoint", requestData);

// 에러 처리
try {
	const result = await ApiClient.post("/api/signup", userData);
} catch (error) {
	// error.message에는 사용자 친화적 메시지가 포함됨
	setError(error.message);
}
```

## 🚀 다음 단계

### 추가 개선 계획

- [ ] cats.ts, courses.ts 등 Mock 서비스를 실제 API로 전환 시 ApiClient 적용
- [ ] 요청/응답 로깅 기능 추가
- [ ] API 응답 캐싱 기능 구현
- [ ] 재시도(Retry) 로직 추가

### 팀 공유 사항

- 새로운 API 서비스 작성 시 반드시 ApiClient 사용
- 에러 메시지 추가 시 `extractErrorMessage`에 패턴 등록
- 기존 서비스를 점진적으로 ApiClient로 마이그레이션

## 🔗 관련 링크

- 관련 이슈: 회원가입 JSON 파싱 에러 문제
- 참고 자료: [Fetch API Error Handling Best Practices](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)

## 📝 비고

- 이 리팩토링으로 향후 모든 API 관련 에러 처리가 일관되게 처리됩니다
- 새로운 개발자가 API 서비스를 작성할 때 복잡한 에러 처리 로직을 고민할 필요가 없습니다
- 서버에서 다양한 형태의 응답이 와도 안전하게 처리됩니다
